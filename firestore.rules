rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to list/query the rooms collection (for active rooms page)
    match /rooms/{document=**} {
      allow list: if request.auth != null;
    }
    
    match /rooms/{roomId} {
      function isAuthed() {
        return request.auth != null;
      }

      function isController() {
        return isAuthed() && resource.data.controllerUid == request.auth.uid;
      }

      // IMPORTANT: inside nested matches (sessions/*), `resource` refers to the nested doc,
      // not the room doc. Use this helper to check controller against the room.
      function isRoomController() {
        return isAuthed()
          && get(/databases/$(database)/documents/rooms/$(roomId)).data.controllerUid == request.auth.uid;
      }

      // For family use we allow authenticated reads so join-by-code works.
      allow read: if isAuthed();

      // Room creator becomes controller.
      allow create: if isAuthed()
        && request.resource.data.controllerUid == request.auth.uid
        && request.resource.data.raceTrackId == 'christmas_race_v1';

      // Controller can update anything.
      // Additionally: allow any authed user to start the race (lobby -> running)
      // by changing ONLY status + raceStartedAt.
      // For Family Feud: allow players to update currentSession fields for gameplay
      allow update: if isAuthed() && (
        (resource.data.controllerUid == request.auth.uid)
        || (
          resource.data.status == 'lobby'
          && request.resource.data.status == 'running'
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'raceStartedAt'])
        )
        || (
          // Family Feud: allow authenticated users to update currentSession for gameplay
          resource.data.currentSession != null
          && resource.data.currentSession.gameId == 'family_feud'
          && request.resource.data.currentSession != null
          && request.resource.data.currentSession.gameId == 'family_feud'
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['currentSession'])
          && request.resource.data.currentSession.diff(resource.data.currentSession).changedKeys().hasOnly([
            'revealedAnswerIds',
            'teamScores',
            'strikes',
            'status',
            'activeTeam'
          ])
        )
      );

      allow delete: if isController();
      
      // Players subcollection
      match /players/{playerId} {
        allow read: if isAuthed();
        
        // Allow create if user is creating their own player doc
        allow create: if isAuthed() && request.auth.uid == playerId;
        
        // Allow update if user is updating their own player doc or is controller
        allow update: if isAuthed() && (
          request.auth.uid == playerId
          || get(/databases/$(database)/documents/rooms/$(roomId)).data.controllerUid == request.auth.uid
        );
        
        // Allow delete if user is deleting their own doc or is controller
        allow delete: if isAuthed() && (
          request.auth.uid == playerId
          || get(/databases/$(database)/documents/rooms/$(roomId)).data.controllerUid == request.auth.uid
        );
      }

      // Optional TV event feed
      match /events/{eventId} {
        allow read: if isAuthed();
        allow create: if isAuthed();
        allow update, delete: if isController();
      }

      // Mini-game sessions (one room -> many sessions)
      match /sessions/{sessionId} {
        allow read: if isAuthed();
        allow create, update, delete: if isRoomController();

        // Selected deck for this session (single doc: selected/selected)
        match /selected/{docId} {
          allow read: if isAuthed();
          allow create, update, delete: if isRoomController();
        }

        // Per-player answer doc (doc id = uid)
        match /answers/{uid} {
          allow read: if isAuthed();
          allow create, update: if isAuthed() && (
            request.auth.uid == uid
            || isRoomController()
          );
          allow delete: if isRoomController();
        }

        // Per-session scores (controller-owned)
        match /scores/{uid} {
          allow read: if isAuthed();
          allow create, update, delete: if isRoomController();
        }

        // Pictionary session realtime docs + subcollections
        match /pictionary/{docId} {
          allow read: if isAuthed();
          // Allow any authed user to write the live drawing doc (drawer phone),
          // but keep it narrow to expected keys.
          allow create: if isAuthed() && docId == 'live'
            && request.resource.data.keys().hasOnly(['round', 'seq', 'events', 'checkpoint', 'updatedAt']);
          allow update: if isAuthed() && docId == 'live'
            && request.resource.data.diff(resource.data).changedKeys().hasOnly(['round', 'seq', 'events', 'checkpoint', 'updatedAt']);
          allow delete: if isRoomController();

          // Pictionary guesses live under the fixed `live` doc:
          // rooms/{roomId}/sessions/{sessionId}/pictionary/live/guesses/{guessId}
          match /guesses/{guessId} {
            allow read: if isAuthed();
            allow create: if isAuthed() && docId == 'live';
            allow update, delete: if isRoomController();
          }
        }
      }
    }
  }

  // Tradition Wheels
  match /traditionWheels/{wheelId} {
    function isAuthed() {
      return request.auth != null;
    }

    function isController() {
      return isAuthed() && resource.data.controllerUid == request.auth.uid;
    }

    allow read: if isAuthed();
    allow create: if isAuthed() && request.resource.data.controllerUid == request.auth.uid;
    allow update: if isAuthed() && (
      isController()
      || (
        // Allow any authed user to update usedIds and lastSpunAt (for spinning)
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['usedIds', 'lastSpunAt'])
      )
    );
    allow delete: if isController();
  }

  // User profiles - users can read and write their own profile
  match /users/{userId} {
    function isAuthed() {
      return request.auth != null;
    }

    allow read: if isAuthed() && request.auth.uid == userId;
    allow create: if isAuthed() && request.auth.uid == userId;
    allow update: if isAuthed() && request.auth.uid == userId;
    allow delete: if isAuthed() && request.auth.uid == userId;
  }
}

